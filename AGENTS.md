# AGENTS.md
# Project: Interactive Convex Lens Imaging H5 (凸透镜成像互动网页)
# Target: 初中生 | 单文件HTML | 可课堂投影与移动端使用
# Supervisor (human): linics
# Developer Agent: Codex
# Output Files: index_step1.html → index_step2.html → index_final.html

本文件用于**分步驱动**生成项目代码。  
⚠️ **只有当用户明确说出 “开始 Step 1/2/3” 时才执行对应步骤**；执行完毕后**停止**，等待下一步命令。

---

## 🧭 How to Use / 执行方式
- 你（linics）在聊天中发：
  - “**开始 Step 1**” → 只执行 Step 1 的全部指令，产出 `index_step1.html`，结束后停止。
  - “**开始 Step 2**” → 在 Step 1 的基础上实现交互和物理模拟，产出 `index_step2.html`，停止。
  - “**开始 Step 3**” → 增加教学模式/挑战/测验等，产出 `index_final.html`，停止。
- 在没有收到 “开始 Step X” 指令前，Agent 只阅读本文件，**不生成代码**。

---

## ✅ 共同技术约束（适用于 Step 1–3）
- **单文件 HTML**（含内嵌 `<style>` 与 `<script>`），**不依赖外部库/CDN**。
- **中文界面**（变量名/函数名可用英文，注释用中文）。
- **适配** 1366×768 课堂投影 + 移动端：布局自适应（Flex/Grid），控件可触控。
- **SVG 绘制** 光线与箭头（推荐 900×420 px 内部坐标系）；可切 Canvas，但需功能等效。
- **数据单位**统一为 cm（计算层），**渲染层**使用 px，通过线性比例映射：
  - 建议：`SCALE = 12 px/ cm`（可写常量），可放在顶部配置区。
- **键位与无障碍**：滑块可键盘操作；HTML 语义化；颜色非唯一载体（配文案/图标）。
- **性能**：交互刷新采用 `requestAnimationFrame`；每次重绘前清空旧元素，避免叠影。
- **边界容错**：严格处理 `u≈f` 情况，防止除零/发散；对输入值做范围夹取。
- **存储**：如使用 `localStorage`，键采用前缀：`lenslab_*`。
- **调试/测试**：在控制台输出关键计算值与异常提示，方便课堂排错。

---

# 🧩 Step 1 — 页面框架与视觉结构
**Trigger:** 当用户说“**开始 Step 1**”或 “**Please execute Step 1**”。

### 🎯 GOAL
- 仅搭建**布局与样式**（不写 JS 逻辑）。
- 形成清晰的三栏结构：左控制区 / 中画布 / 右信息区。
- 整体风格简洁、适合课堂展示。

### ✅ 输出
- 生成 `index_step1.html`，可单独打开预览布局（但无交互）。

### 🧱 页面结构（HTML 必含区块）
- `<header>`：标题“凸透镜成像实验（Convex Lens Imaging）`
- `<main>`：三栏布局
  - `<section id="controls">` 左侧控制区（先放**占位控件**，不加逻辑）
    - 物距（u）滑块 + 当前值显示占位
    - 焦距（f）滑块 + 当前值显示占位
    - 物高（ho）滑块 + 当前值显示占位
    - “显示光线”开关（占位）
  - `<section id="stage">` 中央画布区
    - `<svg id="lens-svg" viewBox="0 0 900 420" aria-label="凸透镜成像画布">`
    - 预绘**主光轴**（水平线）、**透镜占位**（竖直椭圆/线）、**F/2F占位标注**
    - 占位文本：“此处将显示物体、像与光线路径（Step 2 开启）”
  - `<section id="info">` 右侧信息区（静态占位文本）
    - 卡片 1：当前参数表（u、f、ho）
    - 卡片 2：结果区占位（像距 v、放大率 m、成像性质）
    - 卡片 3：提示区（教学提示语）
- `<footer>`：`© 2025 教育科技实验演示`

### 🎨 样式规范（内嵌 <style>）
- 背景：`#f7f8fa`；卡片：白底 + 阴影 + 16px 圆角；主色：深蓝（文字/边界）。
- 字体：16–18px；标题 22–26px；控件区域行高足够（触控友好）。
- 布局：CSS Grid（3 列：`minmax(260px, 320px)` | `1fr` | `minmax(260px, 320px)`），移动端改为上下堆叠。
- 控件外观：滑块 + 标题 + 数值显示同行；使用粗体标签名：**物距 u**、**焦距 f**、**物高 ho**。
- 信息区卡片包含小标题（如“当前参数”“成像结果”“提示”）。

### 🧪 验收清单
- 打开 `index_step1.html`，能看到三栏与画布占位，文字中文，布局在桌面/移动端都不崩。
- **结束后停止执行，等待“开始 Step 2”。**

---

# 🔬 Step 2 — 交互逻辑与物理计算（实时成像）
**Trigger:** 当用户说“**开始 Step 2**”。

### 🎯 GOAL
- 在 Step 1 基础上加入**完整交互与物理模拟**：
  - 滑块驱动 → 计算（v、m、hi）→ SVG 动态绘制物/像/三条主光线 → 文案与颜色提示。

### ✅ 输出
- 生成 `index_step2.html`（自包含，单独打开可使用）。
- 在控制台打印版本标识：`[LensLab] Step2 build OK`。

### 📐 物理与符号规范（中学简化）
- 成像公式：`1/f = 1/u + 1/v` → `v = (f * u) / (u - f)`
- 放大率：`m = v / u`；像高：`hi = m * ho`
- 判定：
  - `v > 0` → 实像（在透镜右侧）
  - `v < 0` → 虚像（在透镜左侧，与物同侧）
  - `m > 0` → 正立；`m < 0` → 倒立
  - `|u - f| < 0.1` → 视作**不成像**（平行光），中止绘制像与两条折/出射线，仅保留主光轴与透镜，并在信息区提示。

### 🔧 交互控件与范围（写入 HTML）
- 滑块（`input[type=range]`）：
  - `u`（物距）：`min=5`, `max=30`, `step=0.1`, 默认 18
  - `f`（焦距）：`min=5`, `max=15`, `step=0.1`, 默认 10
  - `ho`（物高）：`min=1`, `max=5`, `step=0.1`, 默认 3
- 开关：`showRays`（显示/隐藏三条主光线，默认开）

### 🧠 计算与渲染管线（JS 必做）
- **常量配置**：
  ```js
  const SCALE = 12;        // cm → px
  const ORIGIN_X = 450;    // 透镜中心 x（SVG 中心）
  const AXIS_Y   = 210;    // 主光轴 y
  ```
- **数据状态**：
  ```js
  const state = { u:18, f:10, ho:3, showRays:true };
  ```
- **核心函数**：`updateScene()`（被滑块 `input` 事件与 `requestAnimationFrame` 驱动）
  - 1) 校验与容错（范围夹取；`if (Math.abs(u - f) < 0.1) { setNoImageState(); return; }`）
  - 2) 计算 v、m、hi
  - 3) 将 cm → px，映射到 SVG 坐标：
     - 物体尖端坐标：`(ORIGIN_X - u*SCALE, AXIS_Y - ho*SCALE)`
     - 像尖端坐标：`(ORIGIN_X + v*SCALE, AXIS_Y - hi*SCALE)`（若 v<0 则落在左侧）
  - 4) 清空旧图层（分组 `<g id="rays">`、`<g id="objects">`），重绘：
     - 物体箭头、像箭头（像的方向取决于 m 符号；渲染时高度用 `Math.abs(hi)`，方向用翻转）
     - 三条主光线：
       - 平行主轴 → 过焦点折射
       - 过焦点入射 → 平行主轴出射
       - 过光心 → 直线
     - 焦点/2F 标注（`F` 与 `2F`）
  - 5) 更新信息区文本：
     ```
     物距 u = __ cm
     焦距 f = __ cm
     像距 v = __ cm
     放大率 m = __
     像的性质：实像/虚像；正立/倒立；放大/缩小
     ```
- **动画**：属性变化使用 `requestAnimationFrame` 包裹，避免频繁重绘抖动。

### 🧰 本地存储（可选，若实现则按此约定）
- 读写键：`lenslab_u`, `lenslab_f`, `lenslab_ho`, `lenslab_showRays`
- 页面加载时尝试恢复；滑块变更时保存。

### 🧪 验收清单
- 拖动三个滑块，物/像/光线**实时变化**，u≈f 时显示“不成像”提示。
- 信息区**同步显示**数值与像的性质；颜色区分：**实像=蓝**、**虚像=橙**。
- 控制台无报错；刷新后能恢复上次参数（若实现存储）。
- **结束后停止执行，等待“开始 Step 3”。**

---

# 🧪 Step 3 — 教学模式、挑战与测验
**Trigger:** 当用户说“**开始 Step 3**”。

### 🎯 GOAL
- 将演示升级为**小型虚拟实验课**：模式切换 + 自动归纳表 + 关卡挑战 + 小测验 + 教师模式 +（可选）导出。

### ✅ 输出
- 生成 `index_final.html`（包含 Step 2 的所有功能 + 以下教学功能）。

### 🗂️ 必备模块与说明
#### 1) 模式切换（按钮或标签页）
- “**探索**”：默认，Step 2 行为不变。
- “**规律总结**”：自动采样 u（按区间：u>2f、u=2f、f<u<2f、u=f、u<f）并生成表：
  | 物距区间 | 成像类型 | 像距范围 | 放大率 | 像的特点 |
  |---|---|---|---|---|
  | u > 2f | 实像、倒立、缩小 | f < v < 2f | 0 < m < 1 | … |
  | u = 2f | 实像、倒立、等大 | v = 2f | m = 1 | … |
  | f < u < 2f | 实像、倒立、放大 | v > 2f | m > 1 | … |
  | u = f | 不成像 | — | — | 平行光 |
  | u < f | 虚像、正立、放大 | v < 0 | m > 1 | 放大镜 |
- “**挑战**”：至少 3 关（必须随机化目标/阈值），示例：
  - 关卡 A：使成像为**倒立放大实像**（f=10 cm，要求 u∈(10,20)，v>20）。
  - 关卡 B：使成像**等大**（要求 u≈2f，|u-2f|≤0.3）。
  - 关卡 C：进入**放大镜**模式（要求 u<f）。
  - 评判容差：默认 **±0.5 cm**（常量 `TOL = 0.5` 可被教师模式调整）。
  - 判定成功显示“✅ 完成！”；未达成“❌ 再试试～（给微提示）”
- “**测验**”：3–5 题（必须即时反馈），至少含：
  - 判断题：u<f 时，像是实像（对/错）→ 错（应为虚像正立放大）。
  - 单选题：u=2f 时像的性质？（等大倒立实像）。
  - 计算题：f=10, u=15 → v=?（=30），像性质？（倒立放大实像）。

#### 2) 教师模式（可开关）
- 显示/隐藏：**焦点F**、**2F**标记、**网格背景**、**作图步骤编号**（1/2/3）。
- 容差调节控件（`TOL`），默认 0.5 cm，可调 0.1–1.0。

#### 3) 本地存储（建议）
- `lenslab_mode`（模式）、`lenslab_quizScore`（最近分数）、`lenslab_tol`（教师容差）。
- 挑战进度（关卡通关布尔数组或时间戳）。

#### 4) 友好引导文案（必须）
- 探索：`“拖动滑块看看会发生什么～”`
- 规律：`“对比不同物距的成像，你能总结出规律吗？”`
- 挑战：`“读题后再操作，达成条件会自动判定。”`
- 测验：`“作答后立即看到结果与解析。”`
- 颜色：**实像=蓝**、**虚像=橙**（同 Step 2）。

#### 5) 导出（可选实现）
- “导出总结”按钮：将当前画布+表格合成图片（或调用 `window.print()` 导出为 PDF）。

### 🧪 验收清单
- 四种模式可切换且互不干扰（状态保持）。
- 规律表能正确覆盖五类情形，数值有理（不要显示 NaN/Infinity）。
- 挑战能**稳定判定**（含容差）；测验有反馈与解析，并可重做。
- 教师模式开关对可视化生效；容差调节影响挑战判定。
- 刷新后能保持模式与最近成绩（若实现本地存储）。
- 控制台无报错；移动端不溢出；课堂投影可读性好。

---

## 🧪 科学与边界一致性（Agent 必遵守）
1. **公式与判定**  
   - 仅使用中学简化约定：`1/f = 1/u + 1/v`，`v = fu/(u - f)`，`m = v/u`，`hi = m*ho`。
   - `v>0` 实像（透镜另一侧）、`v<0` 虚像；`m>0` 正立，`m<0` 倒立。
   - 当 `|u-f|<0.1`：显示“不成像（平行光）”，**不得**渲染像与两条折/出射线。
2. **坐标与缩放**  
   - 所有计算基于 cm；渲染用 `SCALE` 转 px；**禁止**混用 px 直接参与物理计算。
3. **绘图可读性**  
   - 三条主光线应带箭头；折/出射点正确（焦点几何关系）；光心线垂直主轴。
4. **性能与稳定**  
   - 重绘使用 `<g>` 分组，先清空后插入；`requestAnimationFrame` 包装更新。
5. **无障碍与配色**  
   - 颜色不是唯一载体；信息区同步显示文字判定与符号。

---

## 🧾 版本与测试（建议 Agent 注入）
- 在 `index_step2.html` 与 `index_final.html` 控制台输出：
  - `[LensLab] Step2 build OK @YYYY-MM-DD`
  - `[LensLab] Step3 build OK @YYYY-MM-DD`
- 提供一个“**自检按钮**”（仅开发可见），点击后自动运行以下断言：
  - `u=25,f=10 → v≈(250/15)=16.67>f`（实像、缩小、倒立）
  - `u=20,f=10 → v=20, m=1`（等大）
  - `u=15,f=10 → v=30, m=2`（倒立放大）
  - `u=10,f=10 → 不成像`
  - `u=8,f=10 → v<0`（正立放大虚像）

---

## 🚦 执行纪律（Agent 必读）
1. **未收到“开始 Step X”前，不得生成任何代码。**
2. 每个 Step 完成后**停止**，并回报“已完成 Step X 的输出文件：…”，等待下一步。
3. 输出文件**自包含**、可直接本地打开运行。
4. 若渲染或计算失败，**优先自检并重试**，同时在页面与控制台提示错误原因与修正方案。
5. 严禁删除本文件或跨步执行（例如在 Step 1 内写 JS，或在 Step 2 擅自加入 Step 3 功能）。

---

## 📌 附：UI 标签微文案（可直接复用）
- **物距 u**｜**焦距 f**｜**物高 ho**｜**像距 v**｜**像高 hi**｜**放大率 m**
- 成像性质：**实像** / **虚像** · **倒立** / **正立** · **放大** / **缩小**
- 提示：**“拖动滑块试试看～”**｜**“接近平行光，不成像”**｜**“恭喜达成目标！”**

---

### END OF FILE
